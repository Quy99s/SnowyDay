{"version":3,"sources":["file:///Users/backup/Desktop/SnowyDay/assets/Script/Joystick.ts"],"names":["_decorator","Component","Node","Vec3","Enum","Vec2","CCInteger","UITransform","Size","UIOpacity","EventTarget","SystemEventType","ccclass","property","instance","SET_JOYSTICK_TYPE","DirectionType","SpeedType","JoystickType","Joystick","type","displayName","tooltip","onLoad","dot","console","warn","ring","uiTransform","getComponent","size","radius","ringSize","setContentSize","getChildByName","_initTouchEvent","uiOpacity","node","joystickType","FOLLOW","opacity","onEnable","on","_onSetJoystickType","onDisable","off","FIXED","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","emit","location","getUILocation","touchPos","x","y","_stickPos","getPosition","moveVec","subtract","distance","length","setPosition","_touchLocation","speedType","NORMAL","normalize","multiplyScalar","FAST","STOP","ALL"],"mappings":"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","sourcesContent":["\nimport { _decorator, Component, Node, Vec3, Enum, Vec2, CCInteger, UITransform, Size, UIOpacity, EventTarget, SystemEventType, EventTouch } from 'cc';\nconst { ccclass, property } = _decorator;\nexport const instance = new EventTarget;\n\nexport const SET_JOYSTICK_TYPE = \"SET_JOYSTICK_TYPE\";\n\n/**\n * 方向类型\n */\nexport enum DirectionType {\n  FOUR,\n  EIGHT,\n  ALL,\n}\n\n/**\n * 速度类型\n */\nexport enum SpeedType {\n  STOP,\n  NORMAL,\n  FAST,\n}\n\n/**\n * 摇杆类型\n */\nexport enum JoystickType {\n  FIXED,\n  FOLLOW,\n}\n\nexport interface JoystickDataType {\n  speedType: SpeedType;\n  /**\n   * 移动向量\n   */\n  moveVec: Vec3;\n}\n\n@ccclass('Joystick')\nexport class Joystick extends Component {\n    @property({\n        type: Node,\n        displayName: \"Dot\",\n        tooltip: \"摇杆操纵点\",\n      })\n      dot: Node | null = null;\n    \n      @property({\n        type: Node,\n        displayName: \"Ring\",\n        tooltip: \"摇杆背景节点\",\n      })\n      ring: Node | null = null;\n    \n      @property({\n        type: Enum(JoystickType),\n        displayName: \"Touch Type\",\n        tooltip: \"触摸类型\",\n      })\n      joystickType = JoystickType.FIXED;\n    \n      @property({\n        type: Enum(DirectionType),\n        displayName: \"Direction Type\",\n        tooltip: \"方向类型\",\n      })\n      directionType = DirectionType.ALL;\n    \n      @property({\n        type: Vec3,\n        tooltip: \"摇杆所在位置\",\n      })\n      _stickPos = new Vec3();\n    \n      @property({\n        type: Vec2,\n        tooltip: \"触摸位置\",\n      })\n      _touchLocation = new Vec2();\n    \n      @property({\n        type: CCInteger,\n        displayName: \"Ring Radius\",\n        tooltip: \"半径\",\n      })\n      radius = 50;\n    \n      onLoad() {\n        if (!this.dot) {\n          console.warn(\"Joystick Dot is null!\");\n          return;\n        }\n    \n        if (!this.ring) {\n          console.warn(\"Joystick Ring is null!\");\n          return;\n        }\n    \n        const uiTransform = this.ring.getComponent(UITransform);\n        const size = this.radius * 2;\n        const ringSize = new Size(size, size);\n        uiTransform?.setContentSize(ringSize);\n        this.ring\n          .getChildByName(\"bg\")!\n          .getComponent(UITransform)\n          ?.setContentSize(ringSize);\n    \n        this._initTouchEvent();\n        // hide joystick when follow\n        const uiOpacity = this.node.getComponent(UIOpacity);\n        if (this.joystickType === JoystickType.FOLLOW && uiOpacity) {\n          uiOpacity.opacity = 0;\n        }\n      }\n    \n      /**\n       * 启用时\n       */\n      onEnable() {\n        instance.on(SET_JOYSTICK_TYPE, this._onSetJoystickType, this);\n      }\n    \n      /**\n       * 禁用时\n       */\n      onDisable() {\n        instance.off(SET_JOYSTICK_TYPE, this._onSetJoystickType, this);\n      }\n    \n      /**\n       * 改变摇杆类型\n       * @param type\n       */\n      _onSetJoystickType(type: JoystickType) {\n        this.joystickType = type;\n        const uiOpacity = this.node.getComponent(UIOpacity);\n        if (uiOpacity) {\n          uiOpacity.opacity = type === JoystickType.FIXED ? 255 : 0;\n        }\n      }\n    \n      /**\n       * 初始化触摸事件\n       */\n      _initTouchEvent() {\n        // set the size of joystick node to control scale\n        this.node.on(SystemEventType.TOUCH_START, this._touchStartEvent, this);\n        this.node.on(SystemEventType.TOUCH_MOVE, this._touchMoveEvent, this);\n        this.node.on(SystemEventType.TOUCH_END, this._touchEndEvent, this);\n        this.node.on(SystemEventType.TOUCH_CANCEL, this._touchEndEvent, this);\n      }\n    \n      /**\n       * 触摸开始回调函数\n       * @param event\n       */\n      _touchStartEvent(event: EventTouch) {\n        if (!this.ring || !this.dot) return;\n    \n        instance.emit(SystemEventType.TOUCH_START, event);\n    \n        const location = event.getUILocation();\n        const touchPos = new Vec3(location.x, location.y);\n    \n        if (this.joystickType === JoystickType.FIXED) {\n          this._stickPos = this.ring.getPosition();\n    \n          // 相对中心的向量\n          const moveVec = touchPos.subtract(this.ring.getPosition());\n          // 触摸点与圆圈中心的距离\n          const distance = moveVec.length();\n    \n          // 手指在圆圈内触摸,控杆跟随触摸点\n          if (this.radius > distance) {\n            this.dot.setPosition(moveVec);\n          }\n        } else if (this.joystickType === JoystickType.FOLLOW) {\n          // 记录摇杆位置，给 touch move 使用\n          this._stickPos = touchPos;\n          this.node.getComponent(UIOpacity)!.opacity = 255;\n          this._touchLocation = event.getUILocation();\n          // 更改摇杆的位置\n          this.ring.setPosition(touchPos);\n          this.dot.setPosition(new Vec3());\n        }\n      }\n    \n      /**\n       * 触摸移动回调函数\n       * @param event\n       */\n      _touchMoveEvent(event: EventTouch) {\n        if (!this.dot || !this.ring) return;\n    \n        // 如果 touch start 位置和 touch move 相同，禁止移动\n        if (\n          this.joystickType === JoystickType.FOLLOW &&\n          this._touchLocation === event.getUILocation()\n        ) {\n          return false;\n        }\n    \n        // 以圆圈为锚点获取触摸坐标\n        const location = event.getUILocation();\n        const touchPos = new Vec3(location.x, location.y);\n        // move vector\n        const moveVec = touchPos.subtract(this.ring.getPosition());\n        const distance = moveVec.length();\n    \n        let speedType = SpeedType.NORMAL;\n        if (this.radius > distance) {\n          this.dot.setPosition(moveVec);\n          speedType = SpeedType.NORMAL;\n        } else {\n          // 控杆永远保持在圈内，并在圈内跟随触摸更新角度\n          this.dot.setPosition(moveVec.normalize().multiplyScalar(this.radius));\n          speedType = SpeedType.FAST;\n        }\n    \n        instance.emit(SystemEventType.TOUCH_MOVE, event, {\n          speedType,\n          moveVec: moveVec.normalize(),\n        });\n      }\n    \n      /**\n       * 触摸结束回调函数\n       * @param event\n       */\n      _touchEndEvent(event: EventTouch) {\n        if (!this.dot || !this.ring) return;\n    \n        this.dot.setPosition(new Vec3());\n        if (this.joystickType === JoystickType.FOLLOW) {\n          this.node.getComponent(UIOpacity)!.opacity = 0;\n        }\n    \n        instance.emit(SystemEventType.TOUCH_END, event, {\n          speedType: SpeedType.STOP,\n        });\n      }\n}\n"]}